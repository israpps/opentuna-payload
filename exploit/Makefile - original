#OpenTuna exploit Makefile
#alexparrado (2020)

#Choose paylad you want 
PAYLOAD=launcher-keys

#OpenTuna load address
LOADADDR  = 0x20b020bc
STACKADDR = 0xA8000
STACKSIZE = 0x04000
HEAPSIZE = 0x04000


LDPARAMS := -Wl,--defsym -Wl,_stack_size=$(STACKSIZE) -Wl,--defsym -Wl,_heap_size=$(HEAPSIZE) -Wl,--defsym -Wl,_stack=$(STACKADDR)



EE_TARGET=payload
EE_BIN = $(EE_TARGET).elf
EE_BIN_RAW = $(EE_TARGET).bin
EE_BIN_STRIPPED = $(EE_TARGET)-stripped.elf
EE_OBJS = main.o   payload_elf.o
EE_LDFLAGS +=  -nostartfiles -Wl,-Ttext -Wl,$(LOADADDR) -s $(LDPARAMS)  -Wl,--gc-sections 
EE_CFLAGS=-Os 


all:
	$(MAKE) $(EE_BIN_RAW) 


payload_elf.s: 
	$(MAKE) -C ../$(PAYLOAD)/
	bin2s ../$(PAYLOAD)/payload-packed.elf payload_elf.s payload_elf	

clean:
	$(MAKE) -C ../$(PAYLOAD)/ clean
	rm -f *.elf *.o *.s *.bin


			

$(EE_BIN_STRIPPED): $(EE_BIN)
	$(EE_STRIP) -s -R .comment -R .gnu.version --strip-unneeded -o $@ $<

#Rule for raw binary to embed into icon.icn 	
$(EE_BIN_RAW): $(EE_BIN_STRIPPED)
	ee-objcopy -O binary -v $< $@ 



	
include $(PS2SDK)/samples/Makefile.pref
include $(PS2SDK)/samples/Makefile.eeglobal

